<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Consultorios (JSONP)</title>
  <link rel="stylesheet" href="style.css">
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwBBGfDXkPizYzt_wr6sDnhEUPyyw4FvdhBv1yKhlf5tNYmrt4VMe86mAn_451NUTHiiQ/exec';

    function calcularEstado(c) {
      if ((c.ReservadoHorarios||'').trim()) return 'Reservado';
      if ((c.OcupadoHorarios ||'').trim()) return 'Ocupado';
      return 'Libre';
    }

    // JSONP para listar
    function cargarConsultorios() {
      window.listCB = function(data) {
        document.getElementById('mensaje').textContent = '';
        const cont = document.getElementById('lista');
        cont.innerHTML = '';
        data.forEach(c => {
          const est = calcularEstado(c);
          const btnAccion = est === 'Libre'   ? 'Ocupado'
                         : est === 'Ocupado'  ? 'Reservado'
                                               : 'Liberar';
          const textoBtn = est === 'Libre'   ? 'Marcar Ocupado'
                         : est === 'Ocupado'  ? 'Reservar'
                                               : 'Liberar';
          const div = document.createElement('div');
          div.className = `consultorio ${est.toLowerCase()}`;
          div.innerHTML = `
            <h2>Consultorio ${c.Consultorio}</h2>
            <p><strong>Estado:</strong> ${est}</p>
            <p><strong>Ocupado por:</strong> ${c.OcupadoPor||'-'}</p>
            <p><strong>Última:</strong> ${
              c.ÚltimaActualización
                ? new Date(c.ÚltimaActualización).toLocaleString()
                : '-'
            }</p>
            <button onclick="actualizarEstado(${c.Consultorio}, '${btnAccion}')">
              ${textoBtn}
            </button>
          `;
          cont.appendChild(div);
        });
      };
      const s = document.createElement('script');
      s.src = `${API_URL}?callback=listCB`;
      document.body.appendChild(s);
    }

    // JSONP para actualizar
    function actualizarEstado(num, nuevoEstado) {
      const persona = prompt(`¿Quién pone "${nuevoEstado}"?`);
      if (!persona) return;
      let horario = '';
      if (nuevoEstado !== 'Liberar') {
        horario = prompt('¿Horario? (ej. 16:00-17:00)');
        if (!horario) return;
      }
      window.updateCB = function(res) {
        if (!res.success) alert('Error: ' + res.error);
        cargarConsultorios();
      };
      const params = [
        `callback=updateCB`,
        `Consultorio=${num}`,
        `Tipo=${encodeURIComponent(nuevoEstado)}`,
        `OcupadoPor=${encodeURIComponent(persona)}`,
        `Horario=${encodeURIComponent(horario)}`
      ].join('&');
      const s = document.createElement('script');
      s.src = `${API_URL}?${params}`;
      document.body.appendChild(s);
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('mensaje').textContent = 'Cargando…';
      cargarConsultorios();
    });
  </script>
</head>
<body>
  <h1>Estado de Consultorios</h1>
  <div id="mensaje"></div>
  <div id="lista" class="grid"></div>
</body>
</html>
