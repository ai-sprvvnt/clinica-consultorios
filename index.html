<!-- index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estado de Consultorios</title>
  <link rel="stylesheet" href="style.css">
  <script>
    // === PON AQUÍ LA URL DE TU WEBAPP PUBLICADA ===
    const API_URL = 'https://script.google.com/macros/s/AKfycbwmEt0-HaELEqqwcVK3oFjg_r_Xok95O6fsqwe9wIlzSOcqAR1W0FHqJWuimS9seHJLxA/exec';

    // Determina si está ocupado o reservado, o libre
    function calcularEstado(c) {
      if ((c.ReservadoHorarios || '').trim()) return 'Reservado';
      if ((c.OcupadoHorarios  || '').trim()) return 'Ocupado';
      return 'Libre';
    }

    // Carga y dibuja todas las tarjetas de consultorios
    async function cargarConsultorios() {
      try {
        const res  = await fetch(API_URL);
        const data = await res.json();

        const cont = document.getElementById('lista');
        cont.innerHTML = '';

        data.forEach(c => {
          const estado = calcularEstado(c);
          const tarjeta = document.createElement('div');
          tarjeta.classList.add('consultorio', estado.toLowerCase());
          tarjeta.innerHTML = `
            <h2>Consultorio ${c.Consultorio}</h2>
            <p><strong>Estado:</strong> ${estado}</p>
            <p><strong>Ocupado por:</strong> ${c.OcupadoPor || '-'}</p>
            <p><strong>Última actualización:</strong> ${
              c.ÚltimaActualización
                ? new Date(c.ÚltimaActualización).toLocaleString()
                : '-'
            }</p>
            <button onclick="actualizarEstado(
               ${c.Consultorio},
               '${estado === 'Libre' ? 'Ocupado'
                 : estado === 'Ocupado'  ? 'Reservado'
                                         : 'Liberar'}'
            )">
              ${estado === 'Libre' ? 'Marcar Ocupado'
               : estado === 'Ocupado'  ? 'Reservar'
                                       : 'Liberar'}
            </button>
          `;
          cont.appendChild(tarjeta);
        });

        document.getElementById('mensaje').textContent = '';
      } catch (err) {
        console.error(err);
        document.getElementById('mensaje').textContent = 'Error cargando datos.';
      }
    }

    // Solicita persona y horario, y envía el POST
    async function actualizarEstado(num, nuevoEstado) {
      const persona = prompt(`¿Quién cambia el estado a ${nuevoEstado}?`);
      if (!persona) return;

      let horario = '';
      if (nuevoEstado !== 'Liberar') {
        horario = prompt('¿En qué horario? (ej. 16:00-17:00)');
        if (!horario) return;
      }

      try {
        const res    = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            Consultorio: num,
            Tipo:        nuevoEstado,
            OcupadoPor:  persona,
            Horario:     horario
          })
        });
        const result = await res.json();
        if (!result.success) {
          alert('Error: ' + result.error);
        } else {
          cargarConsultorios();
        }
      } catch (err) {
        console.error(err);
        alert('No se pudo enviar la petición.');
      }
    }

    // Al iniciar la página
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('mensaje').textContent = 'Cargando…';
      cargarConsultorios();
    });
  </script>
</head>
<body>
  <h1>Estado de Consultorios</h1>
  <div id="mensaje"></div>
  <div id="lista" class="grid"></div>
</body>
</html>
